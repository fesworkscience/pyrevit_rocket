<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <Package Name="CPSK Tools for Revit"
           Manufacturer="CPSK"
           Version="$(var.Version)"
           UpgradeCode="E8A5C7B2-4F3D-4E9A-B6C8-1A2B3C4D5E6F"
           Scope="perUser"
           Compressed="yes">

    <SummaryInformation Description="CPSK Tools for Revit" />
    <Media Id="1" Cabinet="cpsk.cab" EmbedCab="yes" CompressionLevel="high" />
    <MajorUpgrade DowngradeErrorMessage="Newer version installed." AllowSameVersionUpgrades="yes" />

    <Property Id="PYREVIT_VERSION" Value="$(var.PyRevitVersion)" />
    <Property Id="PYREVIT_URL" Value="$(var.PyRevitUrl)" />
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="INSTALLFOLDER" Name="CPSK">
        <Directory Id="EXTENSIONFOLDER" Name="CPSK.extension" />
        <Directory Id="TOOLSFOLDER" Name="tools" />
      </Directory>
    </StandardDirectory>

    <ComponentGroup Id="ToolsComponents" Directory="TOOLSFOLDER">
      <Component Id="InstallPyRevitScript" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="InstallPyRevitPS1" Source="build\Install-PyRevit.ps1" KeyPath="yes" />
      </Component>
      <Component Id="RegisterExtensionScript" Guid="B2C3D4E5-F6A7-8901-BCDE-F12345678901">
        <File Id="RegisterExtensionPS1" Source="build\Register-Extension.ps1" KeyPath="yes" />
      </Component>
      <Component Id="UninstallScript" Guid="C3D4E5F6-A7B8-9012-CDEF-123456789012">
        <File Id="UninstallPS1" Source="build\Uninstall-CPSK.ps1" KeyPath="yes" />
      </Component>
      <Component Id="VersionFile" Guid="D4E5F6A7-B8C9-0123-DEF0-234567890123">
        <File Id="VersionTxt" Source="build\version.txt" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="RegistryComponents" Directory="INSTALLFOLDER">
      <Component Id="RegistryEntries" Guid="E5F6A7B8-C9D0-1234-EF01-345678901234">
        <RegistryKey Root="HKCU" Key="Software\CPSK\Tools">
          <RegistryValue Name="Version" Type="string" Value="$(var.Version)" />
          <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" />
        </RegistryKey>
      </Component>
    </ComponentGroup>

    <CustomAction Id="InstallPyRevit"
                  Directory="TOOLSFOLDER"
                  Execute="deferred"
                  Impersonate="yes"
                  ExeCommand='cmd.exe /c start "CPSK Tools - Installing pyRevit" /wait powershell.exe -NoProfile -ExecutionPolicy Bypass -File "[TOOLSFOLDER]Install-PyRevit.ps1" -RequiredVersion "[PYREVIT_VERSION]" -DownloadUrl "[PYREVIT_URL]"'
                  Return="ignore" />

    <CustomAction Id="RegisterExtension"
                  Directory="TOOLSFOLDER"
                  Execute="deferred"
                  Impersonate="yes"
                  ExeCommand='cmd.exe /c start "CPSK Tools - Registering Extension" /wait powershell.exe -NoProfile -ExecutionPolicy Bypass -File "[TOOLSFOLDER]Register-Extension.ps1" -ExtensionPath "[EXTENSIONFOLDER]"'
                  Return="ignore" />

    <CustomAction Id="UnregisterExtension"
                  Directory="TOOLSFOLDER"
                  Execute="deferred"
                  Impersonate="yes"
                  ExeCommand='cmd.exe /c start "CPSK Tools - Uninstalling" /wait powershell.exe -NoProfile -ExecutionPolicy Bypass -File "[TOOLSFOLDER]Uninstall-CPSK.ps1" -ExtensionPath "[EXTENSIONFOLDER]"'
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="InstallPyRevit" After="InstallFiles" Condition="NOT Installed" />
      <Custom Action="RegisterExtension" After="InstallPyRevit" Condition="NOT Installed" />
      <Custom Action="UnregisterExtension" Before="RemoveFiles" Condition="REMOVE" />
    </InstallExecuteSequence>

    <Feature Id="MainFeature" Title="CPSK Tools for Revit" Level="1">
      <ComponentGroupRef Id="ExtensionFiles" />
      <ComponentGroupRef Id="ToolsComponents" />
      <ComponentGroupRef Id="RegistryComponents" />
    </Feature>

  </Package>
</Wix>
