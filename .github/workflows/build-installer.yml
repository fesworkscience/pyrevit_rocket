name: Build MSI Installer

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: false
        default: ''

env:
  PYREVIT_VERSION: "4.8.16.24121"
  PYREVIT_URL: "https://github.com/pyrevitlabs/pyRevit/releases/download/v4.8.16.24121/pyRevit_4.8.16.24121_signed.exe"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
          } elseif ($env:GITHUB_REF -match "refs/tags/v(.+)") {
            $version = $matches[1]
          } else {
            $version = "0.0.1-dev"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare build directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "build" -Force
          Copy-Item -Path "pyrevit.extension" -Destination "build\CPSK.extension" -Recurse
          Copy-Item -Path "installer\scripts\*" -Destination "build\" -Force
          "${{ steps.version.outputs.VERSION }}" | Out-File -FilePath "build\version.txt" -Encoding UTF8 -NoNewline

      - name: Compile Python to .pyc
        shell: pwsh
        run: |
          $env:PYTHONIOENCODING = "utf-8"
          python -m compileall -b -q "build\CPSK.extension"
          Get-ChildItem -Path "build\CPSK.extension" -Recurse -Filter "*.py" | ForEach-Object {
            $pycPath = $_.FullName -replace '\.py$', '.pyc'
            if (Test-Path $pycPath) { Remove-Item $_.FullName -Force }
          }

      - name: Install WiX Toolset
        shell: pwsh
        run: |
          dotnet tool install --global wix --version 4.0.5

      - name: Generate files.wxs
        shell: pwsh
        run: |
          $source = "build\CPSK.extension"
          $output = "installer\files.wxs"

          function Get-SafeId($path) {
            $hash = [System.BitConverter]::ToString([System.Security.Cryptography.MD5]::Create().ComputeHash([System.Text.Encoding]::UTF8.GetBytes($path))).Replace("-","").Substring(0,16)
            return $hash
          }

          $directories = @{}
          $components = @()

          Get-ChildItem -Path $source -Recurse -File | ForEach-Object {
            $relPath = $_.FullName.Substring((Get-Item $source).FullName.Length + 1)
            $relDir = Split-Path -Parent $relPath
            $fileName = $_.Name

            if ($relDir -and -not $directories.ContainsKey($relDir)) {
              $directories[$relDir] = "D_" + (Get-SafeId $relDir)
            }

            $dirId = if ($relDir) { $directories[$relDir] } else { "EXTENSIONFOLDER" }
            $fileId = "F_" + (Get-SafeId $relPath)
            $compId = "C_" + (Get-SafeId $relPath)
            $srcPath = "`$(var.ExtensionSource)\$relPath"

            $components += @{
              CompId = $compId
              FileId = $fileId
              DirId = $dirId
              Source = $srcPath
            }
          }

          $xml = @"
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Fragment>
    <DirectoryRef Id="EXTENSIONFOLDER">
"@

          $sortedDirs = $directories.GetEnumerator() | Sort-Object { $_.Key.Split('\').Count }, { $_.Key }
          $createdDirs = @{}

          foreach ($dir in $sortedDirs) {
            $parts = $dir.Key.Split('\')
            $parentId = "EXTENSIONFOLDER"
            $currentPath = ""

            for ($i = 0; $i -lt $parts.Count; $i++) {
              $part = $parts[$i]
              $currentPath = if ($currentPath) { "$currentPath\$part" } else { $part }

              if (-not $createdDirs.ContainsKey($currentPath)) {
                $dirId = if ($i -eq $parts.Count - 1) { $dir.Value } else { "D_" + (Get-SafeId $currentPath) }
                $indent = "      " + ("  " * $i)
                $xml += "`n$indent<Directory Id=`"$dirId`" Name=`"$part`">"
                $createdDirs[$currentPath] = @{ Id = $dirId; Depth = $i }
              }
              $parentId = $createdDirs[$currentPath].Id
            }
          }

          $maxDepth = ($createdDirs.Values | Measure-Object -Property Depth -Maximum).Maximum
          if ($null -eq $maxDepth) { $maxDepth = -1 }
          for ($d = $maxDepth; $d -ge 0; $d--) {
            $dirsAtDepth = $createdDirs.GetEnumerator() | Where-Object { $_.Value.Depth -eq $d } | Sort-Object { $_.Key } -Descending
            foreach ($dir in $dirsAtDepth) {
              $indent = "      " + ("  " * $dir.Value.Depth)
              $xml += "`n$indent</Directory>"
            }
          }

          $xml += @"

    </DirectoryRef>

    <ComponentGroup Id="ExtensionFiles">
"@

          foreach ($comp in $components) {
            $xml += @"

      <Component Id="$($comp.CompId)" Directory="$($comp.DirId)" Guid="*">
        <File Id="$($comp.FileId)" Source="$($comp.Source)" KeyPath="yes" />
      </Component>
"@
          }

          $xml += @"

    </ComponentGroup>
  </Fragment>
</Wix>
"@

          $xml | Out-File -FilePath $output -Encoding UTF8
          Write-Host "Generated $output with $($components.Count) files and $($directories.Count) directories"

      - name: Build MSI
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          wix build -d Version=$version -d ExtensionSource="build\CPSK.extension" -d PyRevitVersion="${{ env.PYREVIT_VERSION }}" -d PyRevitUrl="${{ env.PYREVIT_URL }}" -out "CPSK_Tools_v$version.msi" "installer\Product.wxs" "installer\files.wxs"

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: CPSK-Tools-MSI
          path: "*.msi"
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "CPSK Tools v${{ steps.version.outputs.VERSION }}"
          body: |
            ## CPSK Tools for Revit v${{ steps.version.outputs.VERSION }}

            ### Установка
            1. Скачайте `CPSK_Tools_v${{ steps.version.outputs.VERSION }}.msi`
            2. Запустите установщик
            3. Перезапустите Revit

            ### Требования
            - Windows 10/11
            - Autodesk Revit 2021-2025
          files: "*.msi"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version.yaml
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          "version: $version" | Out-File -FilePath "version.yaml" -Encoding UTF8 -NoNewline
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.yaml
          git diff --staged --quiet || git commit -m "Update version.yaml to $version"
          git push origin HEAD:master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
