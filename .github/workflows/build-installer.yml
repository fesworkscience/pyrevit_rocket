name: Build Installer

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: false
        default: ''

env:
  PYREVIT_VERSION: "4.8.16.24121"
  PYREVIT_URL: "https://github.com/pyrevitlabs/pyRevit/releases/download/v4.8.16.24121/pyRevit_4.8.16.24121_signed.exe"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
          } elseif ($env:GITHUB_REF -match "refs/tags/v(.+)") {
            $version = $matches[1]
          } else {
            $version = "0.0.1-dev"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Prepare build directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "build" -Force
          Copy-Item -Path "pyrevit.extension" -Destination "build\CPSK.extension" -Recurse
          Copy-Item -Path "installer\scripts\*" -Destination "build\" -Force
          "${{ steps.version.outputs.VERSION }}" | Out-File -FilePath "build\version.txt" -Encoding UTF8 -NoNewline

      - name: Download IronPython
        shell: pwsh
        run: |
          Write-Host "Downloading IronPython 2.7.12..."
          Invoke-WebRequest -Uri "https://github.com/IronLanguages/ironpython2/releases/download/ipy-2.7.12/IronPython.2.7.12.zip" -OutFile "ironpython.zip"
          Expand-Archive -Path "ironpython.zip" -DestinationPath "C:\IronPython" -Force
          Write-Host "IronPython installed to C:\IronPython"
          Get-ChildItem "C:\IronPython" | Select-Object Name

      - name: Compile Python modules to DLL
        shell: pwsh
        run: |
          $ipy = "C:\IronPython\net45\ipy.exe"
          $pyc = "C:\IronPython\net45\Tools\Scripts\pyc.py"
          $libDir = "build\CPSK.extension\lib"

          Write-Host "=== Compiling Python to DLL ==="
          Write-Host "IronPython: $ipy"
          Write-Host "Compiler: $pyc"
          Write-Host "Lib directory: $libDir"

          # Modules to compile (exclude __init__.py and dev tools)
          $modulesToCompile = @(
            "cpsk_auth",
            "cpsk_config",
            "cpsk_notify",
            "cpsk_utils",
            "cpsk_geometry",
            "cpsk_parameters",
            "cpsk_selection",
            "cpsk_dynamo",
            "ids_checker"
          )

          Write-Host "Modules to compile:"
          $modulesToCompile | ForEach-Object { Write-Host "  - $_" }

          # Change to lib directory
          Push-Location $libDir

          # Compile each module to separate DLL (IronPython pyc.py limitation)
          foreach ($module in $modulesToCompile) {
            $pyFile = "$module.py"
            $dllFile = "$module.dll"

            if (Test-Path $pyFile) {
              Write-Host "Compiling $pyFile -> $dllFile"
              & $ipy $pyc /target:dll /out:$dllFile $pyFile 2>&1

              if (Test-Path $dllFile) {
                Write-Host "  [OK] Created $dllFile"

                # Create stub .py file that loads from DLL
                $nl = [Environment]::NewLine
                $stubLines = @(
                  "# -*- coding: utf-8 -*-",
                  "# Auto-generated stub - loads from compiled DLL",
                  "import clr",
                  "import os",
                  "_dll = os.path.join(os.path.dirname(__file__), `"$dllFile`")",
                  "clr.AddReferenceToFileAndPath(_dll)",
                  "from $module import *"
                )
                $stubContent = $stubLines -join $nl

                # Remove original and create stub
                Remove-Item $pyFile -Force
                $stubContent | Out-File -FilePath $pyFile -Encoding UTF8
                Write-Host "  [OK] Created stub $pyFile"
              } else {
                Write-Host "  [WARN] Failed to compile $pyFile, keeping original"
              }
            }
          }

          # Remove dev tools
          if (Test-Path "pyrevit_checker.py") {
            Remove-Item "pyrevit_checker.py" -Force
            Write-Host "Removed: pyrevit_checker.py (dev tool)"
          }

          Pop-Location

          Write-Host "=== Compilation complete ==="
          Write-Host "Files in lib:"
          Get-ChildItem "$libDir" | ForEach-Object {
            Write-Host "  $($_.Name) ($($_.Length) bytes)"
          }

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build Installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $pyrevitVersion = "${{ env.PYREVIT_VERSION }}"
          $pyrevitUrl = "${{ env.PYREVIT_URL }}"

          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DMyAppVersion="$version" `
            /DPyRevitVersion="$pyrevitVersion" `
            /DPyRevitUrl="$pyrevitUrl" `
            /O"." `
            "installer\setup.iss"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CPSK-Tools-Installer
          path: "CPSK_Tools_*.exe"
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "CPSK Tools v${{ steps.version.outputs.VERSION }}"
          body: |
            ## CPSK Tools for Revit v${{ steps.version.outputs.VERSION }}

            ### Установка
            1. Скачайте `CPSK_Tools_v${{ steps.version.outputs.VERSION }}.exe`
            2. Запустите установщик
            3. Перезапустите Revit

            ### Требования
            - Windows 10/11
            - Autodesk Revit 2021-2025

            ### Что нового
            - Современный установщик с прогресс-баром
            - Автоматическая установка pyRevit при необходимости
          files: "CPSK_Tools_*.exe"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
