# Smart Openings - Умные отверстия в плитах

Инструмент управления арматурой при работе с отверстиями в ж/б плитах.

## Цель

Подрезка и восстановление арматуры при создании/удалении отверстий в армированных плитах, сохраняя выноски и параметры экземпляров.

---

## Основные функции

### 1. Обрезать арматуру (после создания отверстия)

**Workflow:**
1. Пользователь создаёт отверстие стандартными средствами Revit
2. Запускает плагин "Обрезать арматуру"
3. Выбирает плиту
4. Выбирает отверстие (или несколько)
5. Плагин показывает preview + настройки
6. Подтверждение → арматура разрезается

### 2. Склеить арматуру и удалить отверстие

**Workflow:**
1. Пользователь запускает плагин "Склеить арматуру"
2. Открывается немодальное окно
3. Пользователь кликает на отверстие в модели
4. Стержни автоматически склеиваются
5. Отверстие автоматически удаляется

---

## Shared Parameters

### CPSK_RebarCutData (Text) - JSON массив

**Назначение:** Список UniqueId (GUID) отверстий, которыми был разрезан стержень.

**Формат:**
```json
["a1b2c3d4-e5f6-...", "f7g8h9i0-j1k2-..."]
```

Или пустой/отсутствует → стержень не разрезался.

**Почему UniqueId, а не ElementId:**
- ElementId меняется при копировании проекта, экспорте/импорте
- UniqueId (GUID) сохраняется между сессиями и проектами
- Получение: `element.UniqueId`

**Принцип:**
- При разрезании оба новых стержня получают `opening.UniqueId` в свой список
- При склейке ищем пары по геометрии среди стержней с нужным UniqueId

**Примеры сценариев:**

### Сценарий 1: Один разрез

```
Исходный:     |----------------|  (параметр пустой)

Отверстие O1: [A]====O1====[B]

A: ["guid-O1"]   ← разрезан O1
B: ["guid-O1"]   ← разрезан O1
```

### Сценарий 2: Два разреза (один стержень дважды)

```
После O1:     [A]====O1====[B]
После O2:     [A]====O1====[B1]====O2====[B2]

A:  ["guid-O1"]                ← разрезан O1
B1: ["guid-O1", "guid-O2"]     ← разрезан O1 и O2
B2: ["guid-O2"]                ← разрезан O2
```

### Сценарий 3: Удаление O1

```
До:    [A]====O1====[B1]====O2====[B2]
       A:[O1]  B1:[O1,O2]  B2:[O2]

Удаляем O1:
1. Получить UniqueId отверстия O1
2. Найти стержни где список содержит guid-O1 → A и B1
3. Проверить геометрию: концы A и B1 рядом? Коллинеарны? → ДА
4. Склеить A + B1
5. Новый список: ["guid-O2"] (O1 убран, O2 остался от B1)
6. Удалить отверстие O1

После: [A+B1]====O2====[B2]
       [O2]           [O2]
```

### Сценарий 4: Удаление O2

```
До:    [A]====O1====[B1]====O2====[B2]

Удаляем O2:
1. Найти стержни с guid-O2 → B1 и B2
2. Геометрия сходится → склеить
3. Новый список: ["guid-O1"] (O2 убран, O1 остался от B1)
4. Удалить отверстие O2

После: [A]====O1====[B1+B2]
       [O1]         [O1]
```

**Почему это работает:**
- UniqueId сохраняется между сессиями Revit
- Нет понятий "левый/правый" - только геометрия
- Каждое отверстие создаёт 2 стержня с одинаковым GUID в списке
- При удалении находим пару по геометрии (концы рядом + коллинеарность)
- Простая структура данных - массив строк

---

## Алгоритмы

### Разрезание стержня

```
ВХОД: плита, список отверстий, настройки (offset, min_length, copy_tags, copy_params)

1. Собрать все Rebar, где Host == плита
2. Для каждого отверстия:
   a. Получить Solid геометрию отверстия
   b. Расширить Solid на offset (буферная зона)

3. Для каждого стержня:
   a. Получить centerline: rebar.GetCenterlineCurves(...)
   b. Для каждого отверстия проверить пересечение curve с solid
   c. Если пересечение есть:
      - Найти точки входа и выхода кривой через solid
      - Вычислить 2 новые кривые:
        * curve_before: от начала до (точка_входа - offset)
        * curve_after: от (точка_выхода + offset) до конца

   d. Проверить минимальную длину:
      - Если curve_before < min_length → не создавать
      - Если curve_after < min_length → не создавать

   e. Создать новые Rebar:
      - rebar_before = Rebar.CreateFromCurves(..., curve_before, ...)
      - rebar_after = Rebar.CreateFromCurves(..., curve_after, ...)

   f. Записать CPSK_RebarCutData:
      - Получить существующий список из исходного стержня (или пустой)
      - Добавить opening.UniqueId
      - Записать в оба новых стержня

   g. Если copy_params:
      - Скопировать все instance-параметры с исходного стержня

   h. Если copy_tags:
      - Найти все IndependentTag, ссылающиеся на исходный стержень
      - Определить на какой новый стержень ближе каждый тег
      - Пересоздать теги на новых стержнях

   i. Удалить исходный стержень

ВЫХОД: количество созданных стержней, количество удалённых
```

### Склейка стержней

```
ВХОД: отверстие для удаления

1. Получить UniqueId отверстия: opening_guid = opening.UniqueId

2. Найти все Rebar в документе где CPSK_RebarCutData содержит opening_guid
   - Парсить JSON, проверять вхождение в массив

3. Сгруппировать стержни в пары по геометрии:
   a. Для каждого стержня получить концы: start_point, end_point
   b. Найти пары где расстояние между концами < tolerance (например 10мм)
   c. Проверить коллинеарность (направления совпадают или противоположны)

4. Для каждой найденной пары (rebar_A, rebar_B):
   a. Определить "внутренние" концы (те что рядом) и "внешние" (дальние)
   b. Создать новую кривую: от внешнего_A до внешнего_B
   c. Создать новый Rebar из этой кривой

   d. Объединить CPSK_RebarCutData:
      - list_A = JSON.parse(rebar_A.CPSK_RebarCutData)
      - list_B = JSON.parse(rebar_B.CPSK_RebarCutData)
      - new_list = (list_A + list_B) - opening_guid  # убрать текущее отверстие
      - Если new_list пустой → не записывать параметр
      - Иначе → записать JSON

   e. Скопировать параметры (от более длинного стержня)

   f. Перенести теги:
      - Найти теги на rebar_A и rebar_B
      - Пересоздать на новом стержне

   g. Удалить rebar_A и rebar_B

5. Если для какого-то стержня пара не найдена:
   - Показать предупреждение: "Стержень {id} был изменён, пара не найдена"
   - Просто убрать opening_guid из его списка

6. Удалить отверстие: doc.Delete(opening.Id)

ВЫХОД: количество склеенных пар, количество предупреждений
```

### Геометрические проверки

```
Коллинеарность двух отрезков:
1. Получить направления: dir_A = (end_A - start_A).Normalize()
2. dir_B = (end_B - start_B).Normalize()
3. Проверить: |dir_A · dir_B| > 0.999 (почти параллельны)
4. Проверить: точки лежат на одной прямой (расстояние от точки до линии < tolerance)

Близость концов:
1. Для всех комбинаций концов (4 варианта):
   - distance(A.start, B.start)
   - distance(A.start, B.end)
   - distance(A.end, B.start)
   - distance(A.end, B.end)
2. Найти минимальное расстояние
3. Если < tolerance → концы "рядом"
```

**Важно:**
- Геометрия - главный критерий, CPSK_RebarCutData - только для фильтрации
- Tolerance для близости концов: ~10-50мм (настраиваемо)
- Если стержень был разрезан 2+ отверстиями, при удалении одного склеиваются только соседние части

### Поиск пересечений

```
1. BoundingBox отверстия + buffer (50мм)
2. BoundingBoxIntersectsFilter для быстрого отсева
3. Solid intersection для точной проверки
4. Фильтр: только Rebar с Host == та же плита
```

---

## UI

### Панель в Ribbon: "КЖ.panel"

```
┌─────────────────────────────────┐
│  [Обрезать]      [Склеить]     │
│   арматуру        арматуру     │
└─────────────────────────────────┘
```

---

### Кнопка "Обрезать арматуру"

**Тип:** Немодальное окно + интерактивный выбор

**Процесс:**
```
1. Пользователь нажимает кнопку
2. Открывается немодальное окно:

┌─────────────────────────────────────────────────┐
│  Обрезать арматуру                         [X]  │
├─────────────────────────────────────────────────┤
│                                                  │
│  1. Кликните на плиту                           │
│  2. Кликните на отверстие(я)                    │
│  3. Нажмите "Обрезать"                          │
│                                                  │
│  ─────────────────────────────────────────────  │
│  Плита: [не выбрана]              [Выбрать]     │
│  Отверстий: 0                     [Выбрать]     │
│  ─────────────────────────────────────────────  │
│                                                  │
│  Настройки:                                      │
│  Отступ от края:        [50] мм                 │
│  Мин. длина стержня:    [100] мм                │
│                                                  │
│  ☑ Переносить выноски                           │
│  ☑ Копировать параметры                         │
│  ─────────────────────────────────────────────  │
│                                                  │
│  Стержней к обрезке: 0                          │
│                                                  │
│  ─────────────────────────────────────────────  │
│  Последнее действие:                            │
│  (нет)                                          │
│  ─────────────────────────────────────────────  │
│                                                  │
│        [Обрезать]           [Закрыть]           │
└─────────────────────────────────────────────────┘

3. Пользователь кликает "Выбрать" рядом с плитой → выбирает в модели
4. Пользователь кликает "Выбрать" рядом с отверстиями → выбирает в модели
5. Окно показывает preview: "Стержней к обрезке: 12"
6. Нажатие "Обрезать" → арматура разрезается
7. В логе: "✓ Обрезано 12 стержней"
8. Можно выбрать другую плиту/отверстия и повторить
```

**Немодальность:**
- Окно остаётся поверх Revit
- Пользователь может взаимодействовать с моделью
- Используется `ExternalEvent` для обработки выбора

---

### Кнопка "Склеить арматуру"

**Тип:** Немодальное окно + интерактивный выбор

**Процесс:**
```
1. Пользователь нажимает кнопку
2. Открывается немодальное окно:

┌─────────────────────────────────────────────────┐
│  Склеить арматуру                          [X]  │
├─────────────────────────────────────────────────┤
│                                                  │
│  Кликните на отверстие в модели.                │
│  Арматура склеится, отверстие удалится.         │
│                                                  │
│  ─────────────────────────────────────────────  │
│  Лог:                                           │
│  ✓ Склеено 4 стержня, отверстие удалено        │
│  ⚠ Стержень 54321: пара не найдена             │
│  ─────────────────────────────────────────────  │
│                                                  │
│              [Закрыть]                          │
└─────────────────────────────────────────────────┘

3. Пользователь кликает на отверстие в модели
4. Стержни склеиваются автоматически
5. Отверстие удаляется автоматически
6. В окне появляется лог действия
7. Пользователь может кликнуть на следующее отверстие
   или закрыть окно
```

**Немодальность:**
- Окно остаётся поверх Revit
- Пользователь может взаимодействовать с моделью
- Используется `ExternalEvent` для обработки кликов

---

## Настройки

### Параметры в немодальном окне

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| Отступ от края | 50 мм | Расстояние от границы отверстия до конца стержня |
| Мин. длина | 100 мм | Стержни короче этого значения удаляются |
| Переносить выноски | Да | Пересоздать теги на новых стержнях |
| Копировать параметры | Да | Скопировать instance-параметры |

### Сохранение последних настроек

Последние использованные значения сохраняются в `cpsk_settings.yaml`:

```yaml
smart_openings:
  last_offset_mm: 50
  last_min_length_mm: 100
  last_copy_tags: true
  last_copy_params: true
```

При открытии окна настройки восстанавливаются из последних значений.

---

## Структура файлов

```
CPSK.tab/
└── КЖ.panel/
    └── Openings.stack/
        ├── CutRebar.pushbutton/
        │   ├── script.py
        │   ├── bundle.yaml
        │   └── icon.png
        └── MergeRebar.pushbutton/
            ├── script.py
            ├── bundle.yaml
            └── icon.png

lib/
├── cpsk_rebar_utils.py      # Утилиты работы с арматурой
└── cpsk_shared_params.py    # Работа с Shared Parameters
```

---

## Shared Parameters File

### Добавить в CPSK_SharedParams.txt

```
*GROUP	CPSK_Rebar
*PARAM	CPSK_RebarCutData	TEXT	# JSON с данными о разрезах
```

### Привязка к категории
- Категория: Structural Rebar (OST_Rebar)
- Instance параметр (не Type)
- Видимость: скрыть от пользователя (служебный параметр)

---

## Ограничения

1. **Area Reinforcement** - см. отдельный раздел ниже
2. **Сложные формы** - работает только с линейными стержнями (не П-образные, не хомуты)
3. **Наклонные стержни** - поддерживаются, требуют 3D пересечения
4. **Группы** - стержни в Model Groups не обрабатываются (предупреждение)
5. **FreeForm Rebar** - не поддерживается (сложная геометрия)

---

## Area Reinforcement и отверстия

### Проблема

Area Reinforcement (зональное армирование) - это контейнер, который автоматически генерирует стержни по площади. Revit API не позволяет редактировать отдельные стержни внутри Area Reinforcement.

### Решение: обязательная конвертация

Для работы с отверстиями Area Reinforcement **должен быть конвертирован** в отдельные Rebar.

### Workflow при обнаружении Area Reinforcement

```
1. Пользователь выбирает плиту
2. Скрипт проверяет: есть ли Area Reinforcement на этой плите?
3. Если есть → показать диалог:

┌─────────────────────────────────────────────────────┐
│  Обнаружено Area Reinforcement                      │
├─────────────────────────────────────────────────────┤
│                                                      │
│  Для обрезки арматуры необходимо конвертировать     │
│  Area Reinforcement в отдельные стержни.            │
│                                                      │
│  Найдено зон: 2                                      │
│  Стержней в зонах: 156                              │
│                                                      │
│  После конвертации вы сможете обрезать арматуру.    │
│                                                      │
│         [Конвертировать]          [Отмена]          │
└─────────────────────────────────────────────────────┘

4. Если пользователь нажал "Отмена" → показать:

┌─────────────────────────────────────────────────────┐
│  Конвертация обязательна                            │
├─────────────────────────────────────────────────────┤
│                                                      │
│  Без конвертации Area Reinforcement в отдельные     │
│  стержни обрезка арматуры невозможна.               │
│                                                      │
│  Area Reinforcement не позволяет редактировать      │
│  отдельные стержни через API.                       │
│                                                      │
│                      [OK]                           │
└─────────────────────────────────────────────────────┘

5. Если пользователь нажал "Конвертировать":
   - Выполнить конвертацию
   - Показать результат: "Создано 156 стержней"
   - Продолжить выбор отверстий
```

### Алгоритм конвертации Area Reinforcement

```
ВХОД: Area Reinforcement элемент

1. Получить все стержни в зоне:
   rebar_ids = area_reinf.GetRebarInSystemIds()

2. Для каждого стержня в зоне:
   a. Получить геометрию: curves = rebar.GetCenterlineCurves(...)
   b. Получить тип арматуры: rebar_type = rebar.GetTypeId()
   c. Получить параметры (диаметр, шаг, защитный слой и т.д.)
   d. Получить Host (плита)

3. Для каждого стержня создать независимый Rebar:
   new_rebar = Rebar.CreateFromCurves(
       doc,
       RebarStyle.Standard,
       rebar_type,
       None, None,  # hooks
       host,
       normal_vector,
       curves,
       ...
   )

4. Скопировать параметры на новый стержень

5. Удалить Area Reinforcement:
   doc.Delete(area_reinf.Id)

ВЫХОД: список созданных Rebar
```

### Важно

- После конвертации теряется "автоматика" Area Reinforcement
- Стержни становятся независимыми элементами
- Это необратимая операция (Undo работает стандартно)

---

## Этапы разработки

### Этап 1: Инфраструктура
- [ ] Shared Parameter (CPSK_RebarCutData) setup
- [ ] cpsk_rebar_utils.py - геометрия арматуры, пересечения
- [ ] cpsk_shared_params.py - работа с JSON параметром

### Этап 2: Обрезка арматуры (CutRebar)
- [ ] Выбор плиты и отверстий
- [ ] Поиск пересекающихся стержней
- [ ] Разрезание стержней
- [ ] Запись данных в CPSK_RebarCutData
- [ ] UI диалог с настройками

### Этап 3: Склейка арматуры (MergeRebar)
- [ ] Немодальное окно с ExternalEvent
- [ ] Выбор отверстия кликом в модели
- [ ] Поиск стержней по CPSK_RebarCutData
- [ ] Геометрическая проверка и склейка
- [ ] Лог действий в окне

### Этап 4: Выноски и параметры
- [ ] Сохранение/восстановление IndependentTag
- [ ] Копирование параметров экземпляра

### Этап 5: UX улучшения
- [ ] Preview затронутых стержней (подсветка)
- [ ] Обработка edge-cases (Area Reinforcement, группы)
- [ ] Предупреждения при несовпадении геометрии

---

## Зависимости

- Revit 2020+ (для RebarConstraintsManager)
- pyRevit
- Shared Parameter File в проекте